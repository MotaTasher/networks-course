# Практика 2. Rest Service

## Программирование. Rest Service. Часть I

### Задание А (3 балла)
Создайте простой REST сервис, в котором используются HTTP операции GET, POST, PUT и DELETE.
Предположим, что это сервис для будущего интернет-магазина, который пока что умеет 
работать только со списком продуктов. У каждого продукта есть поля: `id` (уникальный идентификатор),
`name` и `description`. 

Таким образом, json-схема продукта (обозначим её `<product-json>`):

```json
{
  "id": 0,
  "name": "string",
  "description": "string"
}
```

Данные продукта от клиента к серверу должны слаться в теле запроса в виде json-а, **не** в параметрах запроса.

Ваш сервис должен поддерживать следующие операции:
1. Добавить новый продукт. При этом его `id` должен сгенерироваться автоматически
   - `POST /product`
   - Схема запроса:
     ```json
     {
       "name": "string",
       "description": "string"
     }
     ```
   - Схема ответа: `<product-json>` (созданный продукт)
2. Получить продукт по его id
   - `GET /product/{product_id}`
   - Схема ответа: `<product-json>`
3. Обновить существующий продукт (обновляются только те поля продукта, которые были переданы в теле запроса)
   - `PUT /product/{product_id}`
   - Схема запроса: `<product-json>` (некоторые поля могут быть опущены)
   - Схема ответа: `<product-json>` (обновлённый продукт)
4. Удалить продукт по его id
   - `DELETE /product/{product_id}`
   - Схема ответа: `<product-json>` (удалённый продукт)
5. Получить список всех продуктов 
   - `GET /products`  
   - Схема ответа:
     ```
     [ 
       <product-json-1>,
       <product-json-2>, 
       ... 
     ]
     ```

Предусмотрите возвращение ошибок (например, если запрашиваемого продукта не существует).

Вы можете положить код сервиса в отдельную директорию рядом с этим документом.

### Задание Б (3 балла)
Продемонстрируйте работоспособность сервиса с помощью программы Postman
(https://www.postman.com/downloads) и приложите соответствующие скрины, на которых указаны
запросы и ответы со стороны сервиса для **всех** его операций.

#### Демонстрация работы

1. Нехитро запускаем сервер
<img src="report images/start of server.png" width=500 />

2. Оправляем запрос на добавление 
   
<img src="report images/first post table.png" width=500 />
<img src="report images/second post table.png" width=500 />
<img src="report images/third post table.png" width=500 />

3. Получим отличный стол

<img src="report images/Get great table.png" width=500 />

4. Попросим удалить ужасный стол (и даже сделаем ещё один такой же запрос)

<img src="report images/Del worse table.png" width=500 />
<img src="report images/Del empty object.png" width=500 />

5. Изменим описание

<img src="report images/Change field.png" width=500 />

6. Получим всё и сразу 

<img src="report images/Get all products.png" width=500 />

### Задание В (4 балла)
Пусть ваш продукт также имеет иконку (небольшую картинку). Формат иконки (картинки) может
быть любым на ваш выбор. Для простоты будем считать, что у каждого продукта картинка одна.

Добавьте две новые операции:
1. Загрузить иконку:
   - `POST product/{product_id}/image`
   - Запрос содержит бинарный файл — изображение  
     <img src="images/post-image.png" width=500 />
2. Получить иконку:
   - `GET product/{product_id}/image`
   - В ответе передаётся только сама иконка  
     <img src="images/get-image.png" width=500 />

Измените операции в Задании А так, чтобы теперь схема продукта содержала сведения о загруженной иконке, например, имя файла или путь:
```json
"icon": "string"
```

#### Демонстрация работы

1. Добавим первому столу картинку цветочка

<img src="report images/Post image to 1st table.png" width=500 />

2. И попросим тут же её

<img src="report images/Get image from 1st table.png" width=500 />


---

_(*) В последующих домашних заданиях вам будет предложено расширить функционал данного сервиса._

## Задачи

### Задача 1 (2 балла)
Общая (сквозная) задержка прохождения для одного пакета от источника к приемнику по пути, состоящему из $N$ соединений, имеющих каждый скорость $R$ (то есть между источником и приемником $N - 1$ маршрутизатор), равна $d_{\text{сквозная}} = N \dfrac{L}{R}$ Обобщите данную формулу для случая пересылки количества пакетов, равного $P$.

#### Решение

Заметим, что в случае, когда пакет идёт не один, то появляется необходимость дожидаться посылки впереди стоящего пакета, прежде чем самому становится в очередь. Причём, для очередного пакета, когда он начинает свой путь - ему уже не важно, сколько пакетов впереди - каждый из них в этот момент проходит аналогичную стадию на впередистоящем маршрутизаторе (считаем, что веса всех пакетов одинаковые)

Тогда нужно посчитать, через сколько последний пакет начнётся передаваться с первого маршрутизатора, а время, сколько ему вперёд лететь уже известно. Тогда ответ:

$$ (P - 1 + N) \frac{L}{R} $$

### Задача 2 (2 балла)
Допустим, мы хотим коммутацией пакетов отправить файл с хоста A на хост Б. Между хостами установлены три
последовательных канала соединения со следующими скоростями передачи данных:
$R_1 = 200$ Кбит/с, $R_2 = 3$ Мбит/с и $R_3 = 2$ Мбит/с.
Сколько времени приблизительно займет передача на хост Б файла размером $5$ мегабайт?
Как это время зависит от размера пакета?

#### Решение

Как мы знаем, задержка узла формируется из 4х задержек. Если считать задержку обработки, ожидания и распространения малой - то остаётся для каждого узла посчитать задержку передачи - что есть $\sum\frac{L}{R_i} = \frac{5 \cdot 8000}{200} + \frac{5 \cdot 8000}{3 \cdot 1000} + \frac{5 \cdot 8000}{2 \cdot 1000} = 200 + \frac{40}{3} + 20 = 233\frac{2}{3}$ 


### Задача 3 (2 балла)
Предположим, что пользователи делят канал с пропускной способностью $2$ Мбит/с. Каждому пользователю для передачи данных необходима скорость $100$ Кбит/с, но передает он данные только в течение $20$ процентов времени использования канала. Предположим, что в сети всего $60$ пользователей. А также предполагается, что используется сеть с коммутацией пакетов. Найдите вероятность одновременной передачи данных $12$ или более пользователями.

#### Решение

Предположим чуть более сильное условие, что человек не просто использует в течении 20%, но что в каждый момент времени вероятность, что он в данный момент времени использует канал - 20%

Сразу можно заметить, что $60$ достаточно большое число, $12 = 60 \cdot 0.2$, т.е. по ЦПТ будет примерно $0.5$. Но также приведу и точные вычисления 

Тогда мы хотим найти сумму вероятностей от $12$ до $60$, что столько пользователей используют канал

$\sum_{12}^{60} C_{60}^k \cdot 0.2^k \cdot 0.8 ^ {60 - k}$

```python
import numpy as np
def GetP(start, m, p):
    s = 0
    for i in range(start, m + 1):
        
        s += math.comb(m, i) * (p ** i * (1 - p) ** (m - i))

    return s
GetP(12, 60, 0.2)
```

Я запустил вышеприведённый код на питоне, результат работы - $0.5513825262506543$, что примерно то, что обещала ЦПТ, но отличается на $5$%



### Задача 4 (2 балла)
Пусть файл размером $X$ бит отправляется с хоста А на хост Б, между которыми три линии связи и два коммутатора. Хост А разбивает файл на сегменты по $S$ бит каждый и добавляет к ним заголовки размером $80$ бит, формируя тем самым пакеты длиной $L = 80 + S$ бит. Скорость передачи данных по каждой линии составляет $R$  бит/с. Загрузка линий мала, и очередей пакетов нет. При каком значении $S$ задержка передачи файла между хостами А и Б будет минимальной? Задержкой распространения сигнала пренебречь.

#### Решение

Из первой задачи мы знаем, что если у нас $P$ пакетов и $N = 3$ соединений, то необходимо 
$$
(P - 1 + N) \frac{L}{R} = 
(\frac{X}{S} + 2) \frac{S + 80}{R} = 
$$
$$
= \frac{X + \frac{80X}{S} + 2S + 160}{R}
$$

Как известно, минимум $\frac{a}{x} + bx$ достигается, при $x = \sqrt\frac{a}{b}$

Тогда нам надо взять $S = \sqrt{40X}$

Ответ: $S = \sqrt{40X}$

### Задание 5 (2 балла)
Рассмотрим задержку ожидания в буфере маршрутизатора. Обозначим через $I$ интенсивность
трафика, то есть $I = \dfrac{L a}{R}$.
Предположим, что для $I < 1$ задержка ожидания вычисляется как $\dfrac{I \cdot L}{R (1 – I)}$. 
1. Напишите формулу для общей задержки, то есть суммы задержек ожидания и передачи.
2. Опишите зависимость величины общей задержки от значения $\dfrac{L}{R}$.

#### Решение

1. Задержка ожидания дана, задержка передачи равна $\frac{L}{R}$. Тогда суммарная задержка равна $\dfrac{I \cdot L}{R (1 – I)} + \dfrac{L}{R} = \dfrac{L}{R(1 - I)}$

2. Поделим общую задержку на $\dfrac{L}{R}$, получим $\dfrac{1}{1 - I}$ - т.е. чем ближе интенсивность к единице, тем дольше нам нужно ждать по сравнению с её полным отсутствием