# Практика 4. Прикладной уровень


Уфф, ну и жопа, если честно. Пока разобрался, как составить корректный http запрос, как там какое поле поменять, всё сделать - реально очень больно. Да, нужно было лучше продумать архитектуру, работать, как с json-ами, а не текстом - но для этого нужны были те знания, которые я потом и кровью получил в этот раз...


Так вот, о том, как его запускать - `python3 proxy-server.py port`, опционально через `--black_list` и `--cache` можно передать, пути к файлом, хранящим black list и cache (по умолчанию стоит black_list.txt и cache.txt)

Также, если включить аргумент `--noise`, то будут показываться все отладочные принты, через которые можно убедиться в посещении кеша, попадании в блеклист и просто посмотреть, как нас, оказывается, часто перенаправляют и достать картинку гугла - уже огромный труд

При запросе чего-либо, прокси выхватывает из запроса путь реального хоста, проводя манипуляции с тем, куда мы хотим постучаться и записывает это соответственно. Также попутно сохраняет те хосты, куда мы стучались

Когда от браузера приходят повторные запросы - (где уже не указывается реальный хост), мы попытаемся обработать это как обычный случай, когда был указан хост, но (т.к. закрыли соединение) потом достанем из памяти последний хост, и будем считать, что хотели обращаться к нему

Также после каждого кода 200 мы сохраняем в файл с кешом хост, запрос и полученный ответ (но из минусов, кажется, при перегонке `bytes -> str -> bytes` что-то покарабилось, поэтому формально оно осуществлено, но не работает. Также не реализованна система умного переспрашивания с last-modify, но что-то сделано)

При этом перед тем, как ответить нашему пользователю, мы проверяем, сайт, куда мы в конечном итоге стучались не попадает в black-list (но разрешаем промежуточно постучаться, если нас перенаправляли. Если какой-то сайт был запрещён, то мы можем с него собрать информацию и перенаправиться куда-то дальше)

   <img src="images/0_1.png" width=700 />

   <img src="images/0_2.png" width=700 />

   <img src="images/0_3.png" width=700 />

В случае посещения запретных сайтов - я возвращаю код запрета 404 


## Программирование сокетов: Прокси-сервер
Разработайте прокси-сервер для проксирования веб-страниц. 
Приложите скрины, демонстрирующие работу прокси-сервера. 


### Запуск прокси-сервера
Запустите свой прокси-сервер из командной строки, а затем запросите веб-страницу с помощью
вашего браузера. Направьте запросы на прокси-сервер, используя свой IP-адрес и номер порта.
Например, http://localhost:8888/www.google.com

_(*) Вы должны заменить стоящий здесь 8888 на номер порта в серверном коде, 
то есть тот, на котором прокси-сервер слушает запросы._

Вы можете также настроить непосредственно веб-браузер на использование вашего прокси сервера. 
В настройках браузера вам нужно будет указать адрес прокси-сервера и номер порта,
который вы использовали при запуске прокси-сервера (опционально).

### А. Прокси-сервер без кеширования (4 балла)
1. Разработайте свой прокси-сервер для проксирования http GET запросов от клиента веб-серверу 
   с журналированием проксируемых HTTP-запросов. В файле журнала сохраняется
   краткая информация о проксируемых запросах (URL и код ответа). Кеширование в этом
   задании не требуется. **(2 балла)**
2. Добавьте в ваш прокси-сервер обработку ошибок. Отсутствие обработчика ошибок может
   вызвать проблемы. Особенно, когда клиент запрашивает объект, который не доступен, так
   как ответ 404 Not Found, как правило, не имеет тела, а прокси-сервер предполагает, что
   тело есть и пытается прочитать его. **(1 балл)**
3. Простой прокси-сервер поддерживает только метод GET протокола HTTP. Добавьте
   поддержку метода POST. В запросах теперь будет использоваться также тело запроса
   (body). Для вызова POST запросов вы можете использовать Postman. **(1 балл)**

Приложите скрины или логи работы сервера.

#### Демонстрация работы
todo

### Б. Прокси-сервер с кешированием (4 балла)
Когда прокси-сервер получает запрос, он проверяет, есть ли запрашиваемый объект в кэше, и,
если да, то возвращает объект из кэша без соединения с веб-сервером. Если объекта в кэше нет,
прокси-сервер извлекает его с веб-сервера обычным GET запросом, возвращает клиенту и
кэширует копию для будущих запросов.

Для проверки того, прокис объект в кеше или нет, необходимо использовать условный GET
запрос. В таком случае вам необходимо указывать в заголовке запроса значение для If-Modified-Since и If-None-Match. 
Подробности можно найти [тут](https://ruturajv.wordpress.com/2005/12/27/conditional-get-request).

Будем считать, что кеш-память прокси-сервера хранится на его жестком диске. Ваш прокси-сервер
должен уметь записывать ответы в кеш и извлекать данные из кеша (т.е. с диска) в случае
попадания в кэш при запросе. Для этого необходимо реализовать некоторую внутреннюю
структуру данных, чтобы отслеживать, какие объекты закешированы.

Приложите скрины или логи, из которых понятно, что ответ на повторный запрос был взят из кэша.

#### Демонстрация работы
todo

### В. Черный список (2 балла)
Прокси-сервер отслеживает страницы и не пускает на те, которые попадают в черный список. Вместо
этого прокси-сервер отправляет предупреждение, что страница заблокирована. Список доменов
и/или URL-адресов для блокировки по черному списку задается в **конфигурационном файле**.

Приложите скрины или логи запроса из черного списка.

#### Демонстрация работы
todo

## Wireshark. Работа с DNS
Для каждого задания в этой секции приложите скрин с подтверждением ваших ответов.

### А. Утилита nslookup (1 балл)

#### Вопросы
1. Выполните nslookup, чтобы получить IP-адрес какого-либо веб-сервера в Азии

   Как можно заметить - один из ip адресов для `yahoo.co.jp` - это 182.22.28.252

   <img src="images/1_1.png" width=500 />

2. Выполните nslookup, чтобы определить авторитетные DNS-серверы для какого-либо университета в Европе

   А тут мы видим, что, что у university of oxford есть несколько авторитетных источников (которые, кажется, его же):

   `dns0.ox.ax.uk` 

   <img src="images/1_2.png" width=700 />

3. Используя nslookup, найдите веб-сервер, имеющий несколько IP-адресов. Сколько IP-адресов имеет веб-сервер вашего учебного заведения?

   У `ya.com` их довига:

   <img src="images/1_3.png" width=700 />

   А у СПбГУ он всего 1

   <img src="images/1_4.png" width=500 />

### Б. DNS-трассировка www.ietf.org (3 балла)

#### Подготовка
1. Используйте ipconfig для очистки кэша DNS на вашем компьютере.
2. Откройте браузер и очистите его кэш (для Chrome можете использовать сочетание клавиш
   CTRL+Shift+Del).
3. Запустите Wireshark и введите `ip.addr == ваш_IP_адрес` в строке фильтра, где значение
   ваш_IP_адрес вы можете получить, используя утилиту ipconfig. Данный фильтр позволит
   нам отбросить все пакеты, не относящиеся к вашему хосту. Запустите процесс захвата пакетов в Wireshark.
4. Зайдите на страницу www.ietf.org в браузере.
5. Остановите захват пакетов.

<img src="images/2_1.png" width=1700 />

#### Вопросы
1. Найдите DNS-запрос и ответ на него. С использованием какого транспортного протокола
   они отправлены?
   
   DNS отправляется по UDP (ws показывает, будто по dns, но мы-то с вами знаем, что там всё над udp строится)

2. Какой порт назначения у запроса DNS?

   Судя по всему, из 53 порта


3. На какой IP-адрес отправлен DNS-запрос? Используйте ipconfig для определения IP-адреса
   вашего локального DNS-сервера. Одинаковы ли эти два адреса?

   <img src="images/2_2.png" width=200 />
   
   На ubuntu нет никаких ipconfig, так что смотрел через настройки. И там и тут - один и тот же адрес

4. Проанализируйте сообщение-запрос DNS. Запись какого типа запрашивается? Содержатся
   ли в запросе какие-нибудь «ответы»?

   Тип -A, ответов не содержится

5. Проанализируйте ответное сообщение DNS. Сколько в нем «ответов»? Что содержится в
   каждом?
   
   <img src="images/2_3.png" width=400 />

   2 ответа
   

6. Посмотрите на последующий TCP-пакет с флагом SYN, отправленный вашим компьютером.
   Соответствует ли IP-адрес назначения пакета с SYN одному из адресов, приведенных в
   ответном сообщении DNS?

   <img src="images/2_4.png" width=400 />

    Да, адрес назначения - в точности тот, который я получил из dns беседы

7. Веб-страница содержит изображения. Выполняет ли хост новые запросы DNS перед
   загрузкой этих изображений?
   
   Нет, я полистал после этого TCP запросы и не нашёл ещё `dns`

### В. DNS-трассировка www.spbu.ru (2 балла)

#### Подготовка
1. Запустите захват пакетов с тем же фильтром `ip.addr == ваш_IP_адрес`
2. Выполните команду nslookup для сервера www.spbu.ru
3. Остановите захват
4. Вы увидите несколько пар запрос-ответ DNS. Найдите последнюю пару, все вопросы будут относиться к ней

   <img src="images/3_1.png" width=900 />
   
#### Вопросы
1. Каков порт назначения в запросе DNS? Какой порт источника в DNS-ответе?

   <img src="images/3_2.png" width=900 />

   53 и 59970

2. На какой IP-адрес отправлен DNS-запрос? Совпадает ли он с адресом локального DNS-сервера, установленного по умолчанию?

   В dns общение происходит с портом `192.168.0.1`, что совпадает с ip dns по умолчанию (делаю в другой комнате, поэтому поменялся ip)

3. Проанализируйте сообщение-запрос DNS. Запись какого типа запрашивается? Содержатся
   ли в запросе какие-нибудь «ответы»?

   type A, ответов не имеется 

4. Проанализируйте ответное сообщение DNS. Сколько в нем «ответов»? Что содержится в каждом?

   <img src="images/3_3.png" width=900 />

   2 ответа, в одном пришёл ответ на имя - spbu.ru, а во втором ip

### Г. DNS-трассировка nslookup –type=NS (1 балл)
Повторите все шаги по предварительной подготовке из Задания B, но теперь для команды `nslookup -type=NS spbu.ru`

   <img src="images/4_1.png" width=700 />

   <img src="images/4_2.png" width=700 />

#### Вопросы
1. На какой IP-адрес отправлен DNS-запрос? Совпадает ли он с адресом локального DNS-сервера, установленного по умолчанию?

   И снова да, всё тоже самое 192.168.0.1
   

2. Проанализируйте сообщение-запрос DNS. Запись какого типа запрашивается? Содержатся ли в запросе какие-нибудь «ответы»?

   Теперь тип NS, ответов нет

3. Проанализируйте ответное сообщение DNS. Имена каких DNS-серверов университета в
   нем содержатся? А есть ли их адреса в этом ответе?

   <img src="images/4_3.png" width=900 />

   Теперь 2 NS ответа, в каждом указывается имя, адресов нет

### Д. DNS-трассировка nslookup www.spbu.ru ns2.pu.ru (1 балл)
Снова повторите все шаги по предварительной подготовке из Задания B, но теперь для команды `nslookup www.spbu.ru ns2.pu.ru`.
Запись `nslookup host_name dns_server` означает, что запрос на разрешение доменного имени `host_name` пойдёт к `dns_server`.
Если параметр `dns_server` не задан, то запрос идёт к DNS-серверу по умолчанию (например, к локальному).

   <img src="images/5_1.png" width=900 />

   <img src="images/5_2.png" width=900 />

#### Вопросы
1. На какой IP-адрес отправлен DNS-запрос? Совпадает ли он с адресом локального DNS-сервера, установленного по умолчанию? 
   Если нет, то какому хосту он принадлежит?

   Сначала отправлен на локальный dns, там получили ответ, что нужно идти на 195.70.196.210

2. Проанализируйте сообщение-запрос DNS. Запись какого типа запрашивается? Содержатся
   ли в запросе какие-нибудь «ответы»?

   <img src="images/5_3.png" width=900 />

   Ни в первом запросе, ни во втором - никаких ответов нет, оба раза тип А запрашивается

3. Проанализируйте ответное сообщение DNS. Сколько в нем «ответов»? Что содержится в
   каждом?

   <img src="images/5_4.png" width=900 />

   В первый раз - один ответ А-типа с ip, куда пошли во второй раз

   Во второй - 2 ответа, один А-типа с конечным ip, другой - CNAME, с именем spbu

### Е. Сервисы whois (2 балла)
1. Что такое база данных whois?

   База данных WHOIS содержит информацию о зарегистрированных доменных именах, включая данные о владельце, контактную информацию и даты регистрации. Она используется для проверки доступности доменов, связи с владельцами и мониторинга интернет-активности. WHOIS доступен публично и поддерживается регистраторами доменных имен

2. Используя различные сервисы whois в Интернете, получите имена любых двух DNS-серверов. Какие сервисы вы при этом использовали?

   Я использовал whois.ru

   <img src="images/5_5.png" width=900 />
   <img src="images/5_6.png" width=900 />

   Нашел: ns1.yandexcloud.net и ns1.yandex.ru

3. Используйте команду nslookup на локальном хосте, чтобы послать запросы трем конкретным
   серверам DNS (по аналогии с Заданием Д): вашему локальному серверу DNS и двум DNS-серверам,
   найденным в предыдущей части.
   
   <img src="images/5_7.png" width=900 />

   Обратился с указанием dns, что ещё сказать. Кажется, эта часть завершилась! 
   